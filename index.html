<!DOCTYPE html>
<html>
    <style>

    </style>
    <body>
        <main></main>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.js"></script>
        <button onclick="inspect('down')">Inspect Down</button>
        <button onclick="inspect('up')">Inspect Up</button>
        <button onclick="inspect()">Inspect Forward</button>
        <button onclick="fuel('get')">Get Fuel</button>
        <p id="display">This Shows The Recieved Data</p>
        <div><button class="button" onclick="forward()">Forward</button></div>
        <div><button class="button" onclick="back()">Backward</button></div>
        <select id="comid" class="compid" onchange="iding()"></select>
        <button class="left" onclick="left()">TurnLeft</button>
        <button class="right" onclick="right()">TurnRight</button>
        <div><button class="button" id="up" onclick="up()">Up</button></div>
        <div><button class="button" id="down" onclick="down()">Down</button></div>
    </body>
    <script>
        function setup() {
            createCanvas(400, 400);
        }
        function draw() {
            background(0);
        }
        var complist = [];
        var inselect = [];
        var channel = prompt("What server are you connecting to:", "2.tcp.ngrok.io:10546")
        let idd = undefined;
        if(!channel) {
            window.location.reload(true)
        }
        console.log(channel)
        var w = new WebSocket("ws://"+channel)
        w.addEventListener("open", () => {
            console.log("ok");
            w.send("WebClientConnected")
        });
        var snending = setInterval(function snend() {
            w.send('');
        },20000);
        w.addEventListener("message", (msg) => {
            console.log(msg.data)
            if(msg.data.substring(0,3) == "web") {
                document.getElementById("display").innerHTML = msg.data.substring(3);
            } else if(msg.data.substring(0,4) == "cweb") {
                if(complist) {
                    if(!complist.includes(msg.data.substring(4))) {
                        complist.push(msg.data.substring(4));
                        var opt = document.createElement('option');
                        opt.innerHTML = msg.data.substring(4);
                        document.getElementById('comid').appendChild(opt);
                        idd = `con|${document.getElementById('comid').value.toString()}|`;
                    }
                } else {
                    complist = msg.data.substring(4)
                }
            } else if (msg.data.substring(0,4) == "rweb") {
                if (complist.includes(msg.data.substring(4)) & complist.indexOf(msg.data.substring(4)) > -1) {
                    var selectobject = document.getElementById("comid");
                    for (var i=0; i<selectobject.length; i++) {
                        if (selectobject.options[i].value == msg.data.substring(4)) {
                            selectobject.remove(i);
                            idd = `con|${document.getElementById('comid').value.toString()}|`;
                        }
                    }
                    complist.splice(complist.indexOf(msg.data.substring(4)),1);
                }
            }
            for (let e = 0; e < complist.length; ++e) {
                if (!inselect.includes(complist[e])) {
                    inselect.push(complist[e]);
                } else if (inselect.length > complist.length) {
                    if (!complist.includes[inselect[e]]) {
                        inselect.splice(inselect.indexOf(inselect[e]),1);
                    }
                }
            }
        });
        w.addEventListener("close", () => {
            clearInterval(snending);
        });
        function up() {
            w.send(id+"up");
        };
        function down() {
            w.send(id+"down");
        };
        function left() {
            w.send(id+"left");
        };
        function right() {
            w.send(id+"right");
        };
        function forward() {
            w.send(id+"for");
        };
        function back() {
            w.send(id+"back");
        };
        function fuel(r) {
            console.log("retrieving");
            if (r == "get") {
                w.send(id+"getfuel");
                document.getElementById("display").innerHTML = "Getting";
            }
        }
        function inspect(a) {
            if (a == "down") {
                w.send(id+"inspdown");
                document.getElementById("display").innerHTML = "Getting";
            } else if (a == "up") {
                w.send(id+"inspup");
                document.getElementById("display").innerHTML = "Getting";
            } else if (a != "up" & a != "down") {
                w.send(id+"insp");
                document.getElementById("display").innerHTML = "Getting";
            }
        };
        function iding() {
            idd = `con|${document.getElementById('comid').value.toString()}|`;
        }
    </script>
</html>